import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const TELEGRAM_TOKEN = Deno.env.get('TELEGRAM_BOT_TOKEN')!
const ADMIN_CHAT_ID = Deno.env.get('TELEGRAM_ADMIN_CHAT_ID')!
const SUPABASE_URL = Deno.env.get('SUPABASE_URL')!
const SUPABASE_SERVICE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY')!

const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY)

serve(async (req) => {
    try {
        const body = await req.json()

        // 1. Handle Database Webhook (New Payment Request)
        if (body.type === 'INSERT' && body.table === 'payment_requests') {
            return await handleNewPayment(body.record)
        }

        // 2. Handle Telegram Callback (Button Click)
        if (body.callback_query) {
            return await handleCallbackQuery(body.callback_query)
        }

        return new Response(JSON.stringify({ ok: true }), { status: 200 })
    } catch (error) {
        console.error('Error:', error)
        return new Response(JSON.stringify({ error: error.message }), { status: 500 })
    }
})

async function handleNewPayment(payment: any) {
    const message = `
ğŸ”” *Ø·Ù„Ø¨ Ø¯ÙØ¹ Ø¬Ø¯ÙŠØ¯*

ğŸ’° Ø§Ù„Ù…Ø¨Ù„Øº: ${payment.amount} Ø¬.Ù…
ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date(payment.created_at).toLocaleString('ar-EG')}
ğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: \`${payment.id}\`
ğŸ“ Ø±Ù‚Ù… Ø§Ù„ØªØ­ÙˆÙŠÙ„: ${payment.transfer_phone || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}
  `.trim()

    const keyboard = {
        inline_keyboard: [
            [
                { text: 'âœ… ØªØ£ÙƒÙŠØ¯', callback_data: `confirm_${payment.id}` },
                { text: 'âŒ Ø±ÙØ¶', callback_data: `reject_${payment.id}` }
            ]
        ]
    }

    const response = await fetch(
        `https://api.telegram.org/bot${TELEGRAM_TOKEN}/sendMessage`,
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: ADMIN_CHAT_ID,
                text: message,
                parse_mode: 'Markdown',
                reply_markup: keyboard
            })
        }
    )

    const result = await response.json()

    if (result.ok) {
        await supabase
            .from('payment_requests')
            .update({ telegram_message_id: result.result.message_id })
            .eq('id', payment.id)
    }

    return new Response(JSON.stringify(result), {
        headers: { 'Content-Type': 'application/json' },
        status: 200
    })
}

async function handleCallbackQuery(query: any) {
    const [action, paymentId] = query.data.split('_')
    const isConfirm = action === 'confirm'

    // Update Database
    const { error } = await supabase
        .from('payment_requests')
        .update({
            status: isConfirm ? 'confirmed' : 'rejected',
            confirmed_at: new Date().toISOString(),
            confirmed_by: query.from.username || query.from.first_name
        })
        .eq('id', paymentId)

    if (error) {
        console.error('Database Update Error:', error);
        throw error
    }

    // Update Telegram Message
    const newText = isConfirm
        ? `âœ… *ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯*\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: \`${paymentId}\`\nğŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: ${query.from.first_name}`
        : `âŒ *ØªÙ… Ø§Ù„Ø±ÙØ¶*\n\nğŸ†” Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: \`${paymentId}\`\nğŸ‘¤ Ø¨ÙˆØ§Ø³Ø·Ø©: ${query.from.first_name}`

    await fetch(
        `https://api.telegram.org/bot${TELEGRAM_TOKEN}/editMessageText`,
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chat_id: query.message.chat.id,
                message_id: query.message.message_id,
                text: newText,
                parse_mode: 'Markdown'
            })
        }
    )

    // Answer Callback Query
    await fetch(
        `https://api.telegram.org/bot${TELEGRAM_TOKEN}/answerCallbackQuery`,
        {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                callback_query_id: query.id,
                text: isConfirm ? 'ØªÙ… Ø§Ù„ØªØ£ÙƒÙŠØ¯ âœ…' : 'ØªÙ… Ø§Ù„Ø±ÙØ¶ âŒ'
            })
        }
    )

    return new Response(JSON.stringify({ ok: true }), {
        headers: { 'Content-Type': 'application/json' },
        status: 200
    })
}
