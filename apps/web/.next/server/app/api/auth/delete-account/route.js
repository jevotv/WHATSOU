"use strict";(()=>{var e={};e.id=2392,e.ids=[2392],e.modules={21841:e=>{e.exports=require("@aws-sdk/client-s3")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},48e3:(e,r,t)=>{t.r(r),t.d(r,{headerHooks:()=>w,originalPathname:()=>A,requestAsyncStorage:()=>m,routeModule:()=>_,serverHooks:()=>f,staticGenerationAsyncStorage:()=>h,staticGenerationBailout:()=>g});var o={};t.r(o),t.d(o,{OPTIONS:()=>OPTIONS,POST:()=>POST}),t(44388);var a=t(15789),s=t(74902),i=t(70914),n=t(70106),l=t(19717),u=t(21841);let d=new u.S3Client({region:"auto",endpoint:process.env.R2_ENDPOINT,credentials:{accessKeyId:process.env.R2_ACCESS_KEY_ID||"",secretAccessKey:process.env.R2_SECRET_ACCESS_KEY||""}}),c=process.env.R2_BUCKET_NAME||"whatsou",p=process.env.R2_PUBLIC_URL||"";async function deleteFromR2(e){let r=new u.DeleteObjectCommand({Bucket:c,Key:e});await d.send(r)}async function deleteMultipleFromR2(e){for(let r of e)if(r&&p&&r.includes(p))try{let e=r.replace(`${p}/`,"");await deleteFromR2(e)}catch(e){console.error(`Failed to delete R2 object: ${r}`,e)}}async function OPTIONS(){return new i.Z(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, PUT, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization, X-CSRF-Token, X-Requested-With, Accept, Accept-Version, Content-Length, Content-MD5, Date, X-Api-Version"}})}async function POST(e){return(0,n.Q)(e,async(e,r)=>{try{let t=await e.json(),{reason:o}=t;if(!o||!o.trim())return i.Z.json({error:"Deletion reason is required"},{status:400});let a=(0,l.t)(),{data:s,error:n}=await a.from("users").select("phone").eq("id",r.userId).single();if(n||!s)return i.Z.json({error:"User not found"},{status:404});let{data:u}=await a.from("stores").select("id, name, logo_url").eq("user_id",r.userId).single(),{error:d}=await a.from("deleted_users").insert({phone:s.phone,store_name:u?.name||null,deletion_reason:o,user_id:r.userId});if(d&&console.error("Audit error:",d),u){let e=[];u.logo_url&&e.push(u.logo_url);let{data:r}=await a.from("products").select("id, image_url, thumbnail_url").eq("store_id",u.id);if(r&&r.length>0){let t=r.map(e=>e.id);r.forEach(r=>{r.image_url&&e.push(r.image_url),r.thumbnail_url&&e.push(r.thumbnail_url)});let{data:o}=await a.from("product_images").select("image_url, thumbnail_url").in("product_id",t);o&&o.forEach(r=>{r.image_url&&e.push(r.image_url),r.thumbnail_url&&e.push(r.thumbnail_url)})}if(e.length>0)try{await deleteMultipleFromR2(e)}catch(e){console.error("Failed to cleanup R2 files:",e)}if(r&&r.length>0){let e=r.map(e=>e.id);await a.from("product_images").delete().in("product_id",e),await a.from("product_variants").delete().in("product_id",e)}let{data:t}=await a.from("orders").select("id").eq("store_id",u.id);if(t&&t.length>0){let e=t.map(e=>e.id);await a.from("order_items").delete().in("order_id",e),await a.from("orders").delete().in("id",e)}await a.from("products").delete().eq("store_id",u.id);let{error:o}=await a.from("stores").delete().eq("id",u.id);if(o)throw console.error("Store delete error:",o),Error(`Failed to delete store: ${o.message}`)}let{error:c}=await a.from("users").delete().eq("id",r.userId);if(c)return console.error("User delete error:",c),i.Z.json({error:c.message},{status:500});return i.Z.json({success:!0})}catch(e){return console.error("Delete account error:",e),i.Z.json({error:e.message||"Internal server error"},{status:500})}})}let _=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/auth/delete-account/route",pathname:"/api/auth/delete-account",filename:"route",bundlePath:"app/api/auth/delete-account/route"},resolvedPagePath:"D:\\whatsou\\apps\\web\\app\\api\\auth\\delete-account\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:m,staticGenerationAsyncStorage:h,serverHooks:f,headerHooks:w,staticGenerationBailout:g}=_,A="/api/auth/delete-account/route"}};var r=require("../../../../webpack-runtime.js");r.C(e);var __webpack_exec__=e=>r(r.s=e),t=r.X(0,[771,1861,2605,3926,914,497,5250,9717,106],()=>__webpack_exec__(48e3));module.exports=t})();